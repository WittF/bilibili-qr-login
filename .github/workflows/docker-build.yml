name: Docker Build and Push

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'CHANGELOG.md'
      - 'release.py'
    tags:
      - 'v*.*.*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: bilibili-qr-login

jobs:
  # å‡†å¤‡æ„å»ºä¿¡æ¯
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
      short_sha: ${{ steps.version.outputs.short_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version info
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi
          echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

  # ä¸»æ„å»ºä»»åŠ¡ï¼ˆAMD64 + å¤šå¹³å°ï¼‰
  build:
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: read
      packages: write
    env:
      DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      TRUST_ORIGIN: ${{ secrets.TRUST_ORIGIN }}
      WEBHOOK_IP: ${{ secrets.WEBHOOK_IP }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Workflow overview
        run: |
          echo "ğŸš€ Bç«™ç™»å½•å·¥å…· Docker æ„å»ºä¸å‘å¸ƒæµç¨‹"
          echo "=================================================="
          echo ""
          echo "ğŸ“‹ å·¥ä½œæµç¨‹æ¦‚è§ˆ:"
          echo "  1. ğŸ—ï¸  æ„å»ºé˜¶æ®µ - ç¼–è¯‘Dockeré•œåƒ"
          echo "  2. ğŸš€ å‘å¸ƒé˜¶æ®µ - æ¨é€åˆ°Docker Hub (æ¡ä»¶æ€§)"
          echo "  3. ğŸ“¡ è§¦å‘é˜¶æ®µ - å‘é€éƒ¨ç½²webhook (æ¡ä»¶æ€§)"
          echo "  4. ğŸ§ª éªŒè¯é˜¶æ®µ - æµ‹è¯•å‘å¸ƒçš„é•œåƒ"
          echo ""

      - name: Check build environment
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ..."
          echo "ğŸ“¦ æ„å»ºæ¨¡å¼: ${{ needs.prepare.outputs.is_release == 'true' && 'æ­£å¼å‘å¸ƒ' || 'å¼€å‘æ„å»º' }}"
          echo "ğŸ·ï¸  ç‰ˆæœ¬ä¿¡æ¯: ${{ needs.prepare.outputs.version }}"
          echo "ğŸ—ï¸  æ„å»ºå¹³å°: ${{ needs.prepare.outputs.is_release == 'true' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}"
          echo ""
          
          echo "ğŸ“‹ æ‰§è¡Œè®¡åˆ’:"
          echo "  âœ… æ„å»ºé•œåƒ - æ€»æ˜¯æ‰§è¡Œ"
          
          if [[ "${{ env.DOCKER_PASSWORD }}" != "" ]]; then
            echo "  âœ… æ¨é€åˆ°Docker Hub - å°†æ‰§è¡Œ"
            echo "  âœ… æ›´æ–°ä»“åº“æè¿° - ${{ needs.prepare.outputs.is_release == 'true' && 'å°†æ‰§è¡Œ (æ­£å¼å‘å¸ƒ)' || 'è·³è¿‡ (å¼€å‘æ„å»º)' }}"
          else
            echo "  â­ï¸  æ¨é€åˆ°Docker Hub - è·³è¿‡ (å‡­æ®ä¸å¯ç”¨)"
          fi
          
          if [[ "${{ env.WEBHOOK_IP }}" != "" && "${{ env.DOCKER_PASSWORD }}" != "" ]]; then
            echo "  âœ… è§¦å‘éƒ¨ç½² - å°†æ‰§è¡Œ"
          else
            echo "  â­ï¸  è§¦å‘éƒ¨ç½² - è·³è¿‡ (Webhookæœªé…ç½®æˆ–é•œåƒæœªæ¨é€)"
          fi
          
          echo "  âœ… é•œåƒéªŒè¯ - ${{ vars.DOCKER_USERNAME != '' && 'å°†æ‰§è¡Œ' || 'è·³è¿‡ (æ— Dockerç”¨æˆ·å)' }}"
          echo ""

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag äº‹ä»¶ï¼šç‰ˆæœ¬å·å’Œ latest
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_release == 'true' }},priority=600
            type=raw,value=${{ needs.prepare.outputs.version }},enable=${{ needs.prepare.outputs.is_release == 'true' }},priority=700
            type=raw,value=v${{ needs.prepare.outputs.version }},enable=${{ needs.prepare.outputs.is_release == 'true' }},priority=700
            # Push äº‹ä»¶ï¼šdev å’Œ commit æ ‡ç­¾  
            type=raw,value=dev,enable=${{ needs.prepare.outputs.is_release == 'false' }},priority=400
            type=raw,value=dev-${{ needs.prepare.outputs.short_sha }},enable=${{ needs.prepare.outputs.is_release == 'false' }},priority=500
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_NAME }}
            org.opencontainers.image.description=å“”å“©å“”å“©ç™»å½•å·¥å…·
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Determine platforms
        id: platforms
        run: |
          if [[ "${{ needs.prepare.outputs.is_release }}" == "true" ]]; then
            echo "platforms=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
            echo "Building multi-platform release"
          else
            echo "platforms=linux/amd64" >> $GITHUB_OUTPUT  
            echo "Building AMD64 only for development"
          fi

      # ===== ğŸ—ï¸ æ„å»ºé˜¶æ®µ =====
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ steps.platforms.outputs.platforms }}
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            TRUST_ORIGIN=${{ env.TRUST_ORIGIN }}
            APP_VERSION=${{ needs.prepare.outputs.version }}

      - name: Build success notification
        run: |
          echo "ğŸ‰ Dockeré•œåƒæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
          echo "ğŸ—ï¸  æ„å»ºå¹³å°: ${{ steps.platforms.outputs.platforms }}"

      # ===== ğŸš€ å‘å¸ƒé˜¶æ®µ =====
      - name: Login to Docker Hub
        if: env.DOCKER_PASSWORD != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Push to Docker Hub
        if: env.DOCKER_PASSWORD != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ steps.platforms.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          build-args: |
            TRUST_ORIGIN=${{ env.TRUST_ORIGIN }}
            APP_VERSION=${{ needs.prepare.outputs.version }}

      - name: Push success notification
        if: env.DOCKER_PASSWORD != ''
        run: |
          echo "ğŸš€ é•œåƒå·²æˆåŠŸæ¨é€åˆ°Docker Hubï¼"
          echo "ğŸ”— æŸ¥çœ‹é•œåƒ: https://hub.docker.com/r/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"

      - name: Push skipped notification
        if: env.DOCKER_PASSWORD == ''
        run: |
          echo "â­ï¸ è·³è¿‡Docker Hubæ¨é€ (å‡­æ®ä¸å¯ç”¨)"
          echo "ğŸ’¡ è¿™é€šå¸¸å‘ç”Ÿåœ¨Dependabotæäº¤æˆ–æœªé…ç½®Dockerå‡­æ®æ—¶"

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v3
        if: needs.prepare.outputs.is_release == 'true' && env.DOCKER_PASSWORD != ''
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
          repository: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
          readme-filepath: ./README.md

      # ===== ğŸ“¡ éƒ¨ç½²è§¦å‘é˜¶æ®µ =====
      - name: Test webhook connectivity
        if: env.WEBHOOK_IP != '' && env.DOCKER_PASSWORD != ''
        run: |
          echo "ğŸ”— æµ‹è¯•Webhookè¿æ¥æ€§..."
          curl -f --connect-timeout 10 --max-time 30 \
            -H "User-Agent: GitHub-Actions-Test" \
            http://${{ env.WEBHOOK_IP }}:9000/health || echo "âš ï¸ Webhookç«¯ç‚¹æ— å“åº”ï¼Œä½†å°†ç»§ç»­å°è¯•"

      - name: Trigger deployment webhook
        if: env.WEBHOOK_IP != '' && env.DOCKER_PASSWORD != ''
        run: |
          # è®¾ç½®éƒ¨ç½²å‚æ•°
          if [[ "${{ needs.prepare.outputs.is_release }}" == "true" ]]; then
            IMAGE_TAG="v${{ needs.prepare.outputs.version }}"
            DEPLOY_ENV="production"
            echo "ğŸ·ï¸  å‡†å¤‡è§¦å‘ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
          else
            IMAGE_TAG="dev-${{ needs.prepare.outputs.short_sha }}"
            DEPLOY_ENV="development"
            echo "ğŸ·ï¸  å‡†å¤‡è§¦å‘å¼€å‘ç¯å¢ƒéƒ¨ç½²"
          fi
          
          echo "ğŸ“¡ æ­£åœ¨è§¦å‘ $DEPLOY_ENV ç¯å¢ƒéƒ¨ç½²ï¼Œé•œåƒæ ‡ç­¾: $IMAGE_TAG"
          
          # ç­‰å¾…æ¨é€å®Œæˆ
          sleep 3
          
          # å‘é€webhook
          if curl -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions" \
            -d '{
              "repository": {
                "repo_name": "${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"
              },
              "version": "${{ needs.prepare.outputs.version }}",
              "tag": "'$IMAGE_TAG'",
              "sha": "${{ github.sha }}",
              "environment": "'$DEPLOY_ENV'",
              "is_release": ${{ needs.prepare.outputs.is_release }},
              "commit_message": "${{ github.event.head_commit.message }}",
              "pusher": "${{ github.actor }}"
            }' \
            http://${{ env.WEBHOOK_IP }}:9000/hooks/docker-push; then
            echo "âœ… éƒ¨ç½²Webhookè§¦å‘æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²Webhookè§¦å‘å¤±è´¥ï¼Œä½†æ„å»ºæµç¨‹ç»§ç»­"
          fi

      - name: Webhook skipped notification
        if: env.WEBHOOK_IP == '' || env.DOCKER_PASSWORD == ''
        run: |
          if [[ "${{ env.WEBHOOK_IP }}" == "" ]]; then
            echo "â­ï¸ è·³è¿‡Webhookè§¦å‘ (æœªé…ç½®æœåŠ¡å™¨åœ°å€)"
          elif [[ "${{ env.DOCKER_PASSWORD }}" == "" ]]; then
            echo "â­ï¸ è·³è¿‡Webhookè§¦å‘ (é•œåƒæœªæ¨é€åˆ°Hub)"
          fi
          echo "ğŸ’¡ å¦‚éœ€è‡ªåŠ¨éƒ¨ç½²ï¼Œè¯·é…ç½®WEBHOOK_IPå’ŒDockerå‡­æ®"

  # ===== ğŸ§ª é•œåƒéªŒè¯ä»»åŠ¡ =====
  verify:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: always() && needs.build.result == 'success' && vars.DOCKER_USERNAME != ''
    env:
      DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}

    steps:
      - name: Verify published image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"
          if [[ "${{ needs.prepare.outputs.is_release }}" == "true" ]]; then
            TAG="v${{ needs.prepare.outputs.version }}"
            ENV_TYPE="ç”Ÿäº§ç‰ˆæœ¬"
          else
            TAG="dev-${{ needs.prepare.outputs.short_sha }}"
            ENV_TYPE="å¼€å‘ç‰ˆæœ¬"
          fi
          
          echo "ğŸ§ª å¼€å§‹éªŒè¯ $ENV_TYPE é•œåƒ..."
          echo "ğŸ“¦ é•œåƒåœ°å€: $IMAGE:$TAG"
          
          # æ‹‰å–é•œåƒ
          echo "ğŸ“¥ æ­£åœ¨æ‹‰å–é•œåƒ..."
          if docker pull "$IMAGE:$TAG"; then
            echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
          else
            echo "âŒ é•œåƒæ‹‰å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ¨é€è¿‡ç¨‹ä¸­çš„å»¶è¿Ÿ"
            exit 1
          fi
          
          # è¿è¡Œå®¹å™¨æµ‹è¯•
          echo "ğŸš€ å¯åŠ¨æµ‹è¯•å®¹å™¨..."
          docker run --rm -d --name test-container -p 3001:3000 "$IMAGE:$TAG"
          
          # ç­‰å¾…å®¹å™¨å¯åŠ¨
          echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
          sleep 10
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if docker ps | grep -q test-container; then
            echo "âœ… å®¹å™¨è¿è¡Œæ­£å¸¸"
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            if curl -f http://localhost:3001/ --connect-timeout 5 --max-time 10; then
              echo "âœ… åº”ç”¨å“åº”æ­£å¸¸"
              echo "ğŸ‰ é•œåƒéªŒè¯é€šè¿‡ï¼"
            else
              echo "âš ï¸  åº”ç”¨å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­ï¼Œä½†å®¹å™¨è¿è¡Œæ­£å¸¸"
            fi
          else
            echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
            echo "ğŸ“‹ å®¹å™¨æ—¥å¿—:"
            docker logs test-container || true
            exit 1
          fi
          
          # æ¸…ç†èµ„æº
          echo "ğŸ§¹ æ¸…ç†æµ‹è¯•èµ„æº..."
          docker stop test-container || true
          docker rmi "$IMAGE:$TAG" || true

  # ===== ğŸ§¹ å‘å¸ƒåæ¸…ç†ä»»åŠ¡ =====
  cleanup:
    runs-on: ubuntu-latest
    needs: [prepare, build, verify]
    if: always() && needs.prepare.outputs.is_release == 'true'
    steps:
      - name: Post-release cleanup
        run: |
          echo "ğŸ‰ ç‰ˆæœ¬ v${{ needs.prepare.outputs.version }} å‘å¸ƒå®Œæˆï¼"
          echo "ğŸ“¦ é•œåƒå·²æ¨é€åˆ°: docker.io/${{ vars.DOCKER_USERNAME || 'your-username' }}/bilibili-qr-login"
          echo "ğŸ·ï¸  å¯ç”¨æ ‡ç­¾: latest, v${{ needs.prepare.outputs.version }}, ${{ needs.prepare.outputs.version }}"
          echo ""
          echo "ğŸ§¹ æ‰§è¡Œå‘å¸ƒåæ¸…ç†..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†æ—§çš„æ„å»ºç¼“å­˜çš„é€»è¾‘
          # ä¾‹å¦‚ï¼šæ¸…ç†è¶…è¿‡30å¤©çš„workflowç¼“å­˜ç­‰
          echo "âœ… å‘å¸ƒæµç¨‹å…¨éƒ¨å®Œæˆï¼" 