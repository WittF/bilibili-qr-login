<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bç«™ç™»å½•é›†æˆ - åŸºç¡€ç¤ºä¾‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #00a1d6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #0084b3;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.secondary:hover {
            background: #5a6268;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            min-height: 60px;
        }
        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .status.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .iframe-container {
            margin-top: 15px;
            text-align: center;
        }
        iframe {
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        pre {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
        .cookie-preview {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸª Bç«™ç™»å½•é›†æˆ - åŸºç¡€ç¤ºä¾‹</h1>
    
    <div class="section">
        <h2>ğŸ–¼ï¸ iframeæ¨¡å¼</h2>
        <p>åœ¨å½“å‰é¡µé¢å†…åµŒiframeï¼Œé€‚åˆæ— ç¼é›†æˆï¼š</p>
        <button class="btn" onclick="toggleIframe()">
            <span id="iframe-btn-text">æ‰“å¼€iframeç™»å½•</span>
        </button>
        <button class="btn secondary" onclick="clearResult()">æ¸…é™¤ç»“æœ</button>
        <div id="iframe-container" class="iframe-container"></div>
    </div>

    <div class="section">
        <h2>ğŸªŸ Windowæ¨¡å¼</h2>
        <p>åœ¨æ–°çª—å£æ‰“å¼€ç™»å½•é¡µé¢ï¼Œé€‚åˆæ¡Œé¢ç«¯ï¼š</p>
        <button class="btn" onclick="openWindow()">æ‰“å¼€ç™»å½•çª—å£</button>
        <button class="btn" onclick="openWindow('en')">English Window</button>
        <button class="btn secondary" onclick="clearResult()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="section">
        <h2>ğŸ“Š ç™»å½•ç»“æœ</h2>
        <div id="status"></div>
        <div id="result" class="result">
            ç­‰å¾…ç™»å½•...
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“ æ¶ˆæ¯æ ¼å¼</h2>
        <p>ç™»å½•æˆåŠŸåä¼šæ”¶åˆ°ä»¥ä¸‹æ ¼å¼çš„postMessageï¼š</p>
        <pre><code>{
  "type": "success",
  "mode": "iframe" | "window", 
  "data": "SESSDATA=xxx; bili_jct=xxx; ..."
}</code></pre>
    </div>

    <script>
        let isIframeOpen = false;

        // çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        // æ¶ˆæ¯å¤„ç†å‡½æ•°
        function handleMessage(event) {
            // å®‰å…¨æ£€æŸ¥ï¼šéªŒè¯æ¶ˆæ¯æ¥æº
            if (event.origin !== 'https://login.bilibili.bi') {
                console.warn('æ”¶åˆ°æ¥è‡ªæœªä¿¡ä»»æºçš„æ¶ˆæ¯ï¼Œå·²å¿½ç•¥:', event.origin);
                return;
            }

            const { type, mode, data } = event.data;
            
            if (type === 'success') {
                console.log(`${mode}æ¨¡å¼ç™»å½•æˆåŠŸ`, data);
                
                showStatus(`âœ… ${mode.toUpperCase()}æ¨¡å¼ç™»å½•æˆåŠŸï¼`, 'success');
                
                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                document.getElementById('result').innerHTML = `
                    <div class="status success">
                        <strong>ğŸ‰ ç™»å½•æˆåŠŸ (${mode.toUpperCase()}æ¨¡å¼)</strong>
                    </div>
                    <p><strong>Cookieé•¿åº¦:</strong> ${data.length} å­—ç¬¦</p>
                    <p><strong>è·å–æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    <details>
                        <summary><strong>Cookieå†…å®¹é¢„è§ˆ</strong> (ç‚¹å‡»å±•å¼€)</summary>
                        <div class="cookie-preview">${data.substring(0, 200)}...</div>
                    </details>
                    <small>ğŸ’¡ å®Œæ•´Cookieå·²åœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º</small>
                `;
                
                // æ ¹æ®æ¨¡å¼æ‰§è¡Œåç»­æ“ä½œ
                if (mode === 'iframe') {
                    setTimeout(() => toggleIframe(), 2000); // 2ç§’åè‡ªåŠ¨å…³é—­iframe
                }
                
                // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                window.dispatchEvent(new CustomEvent('biliLoginSuccess', {
                    detail: { cookie: data, mode, timestamp: Date.now() }
                }));
            }
        }

        // iframeæ¨¡å¼
        function toggleIframe(lang = 'zh-CN') {
            const container = document.getElementById('iframe-container');
            const btnText = document.getElementById('iframe-btn-text');
            
            if (!isIframeOpen) {
                const url = `https://login.bilibili.bi/?mode=iframe&lang=${lang}`;
                container.innerHTML = `
                    <iframe 
                        src="${url}" 
                        width="380" 
                        height="340"
                        title="Bç«™ç™»å½•">
                    </iframe>
                `;
                btnText.textContent = 'å…³é—­iframeç™»å½•';
                showStatus('ğŸ–¼ï¸ iframeç™»å½•å·²æ‰“å¼€', 'info');
                document.getElementById('result').innerHTML = 'ğŸ–¼ï¸ ç­‰å¾…iframeç™»å½•...';
                isIframeOpen = true;
            } else {
                container.innerHTML = '';
                btnText.textContent = 'æ‰“å¼€iframeç™»å½•';
                isIframeOpen = false;
                showStatus('iframeå·²å…³é—­', 'info');
            }
        }

        // Windowæ¨¡å¼
        function openWindow(lang = 'zh-CN') {
            const width = 380;
            const height = 340;
            const left = Math.round((window.screen.width - width) / 2);
            const top = Math.round((window.screen.height - height) / 2);
            
            const features = [
                `width=${width}`,
                `height=${height}`,
                `left=${left}`,
                `top=${top}`,
                'resizable=no',
                'scrollbars=no',
                'status=no',
                'toolbar=no',
                'menubar=no',
                'location=no'
            ].join(',');
            
            const url = `https://login.bilibili.bi/?mode=window&lang=${lang}`;
            const popup = window.open(url, 'bili_login', features);
            
            if (!popup) {
                showStatus('âŒ å¼¹çª—è¢«é˜»æ­¢ï¼Œè¯·å…è®¸å¼¹çª—åé‡è¯•', 'error');
                return;
            }
            
            showStatus(`ğŸªŸ ç™»å½•çª—å£å·²æ‰“å¼€ (${lang === 'en' ? 'English' : 'ä¸­æ–‡'})`, 'info');
            document.getElementById('result').innerHTML = 'ğŸªŸ ç­‰å¾…çª—å£ç™»å½•...';
        }

        // æ¸…é™¤ç»“æœ
        function clearResult() {
            document.getElementById('result').innerHTML = 'ç­‰å¾…ç™»å½•...';
            document.getElementById('status').innerHTML = '';
        }

        // æ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨
        window.addEventListener('message', handleMessage);

        // ç›‘å¬è‡ªå®šä¹‰ç™»å½•æˆåŠŸäº‹ä»¶
        window.addEventListener('biliLoginSuccess', (event) => {
            const { cookie, mode, timestamp } = event.detail;
            console.log('æ”¶åˆ°ç™»å½•æˆåŠŸäº‹ä»¶:', { 
                cookieLength: cookie.length, 
                mode, 
                time: new Date(timestamp).toLocaleString() 
            });
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('ğŸ“– é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·é€‰æ‹©ç™»å½•æ–¹å¼è¿›è¡Œæµ‹è¯•', 'info');
        });
    </script>
</body>
</html> 