# 🚀 Docker 构建与发布工作流指南

## 📋 工作流程概览

新的GitHub Actions工作流分为清晰的三个阶段，每个阶段都有明确的职责和条件执行逻辑：

```
🏗️ 构建阶段 → 🚀 发布阶段 → 📡 触发阶段 → 🧪 验证阶段
```

## 🔄 执行流程

### 1. 🏗️ **构建阶段** (总是执行)
- ✅ **Docker镜像构建** - 无论何种情况都会执行
- ✅ **多平台支持** - 正式发布构建AMD64+ARM64，开发构建仅AMD64
- ✅ **缓存优化** - 使用GitHub Actions缓存加速构建
- ✅ **版本标签** - 自动生成适当的镜像标签

### 2. 🚀 **发布阶段** (条件执行)
**执行条件:** `DOCKER_PASSWORD` 可用
- 🔑 **Docker Hub登录** - 使用配置的凭据
- 📤 **镜像推送** - 推送到Docker Hub仓库
- 📝 **描述更新** - 正式发布时更新仓库描述

**跳过情况:**
- ⏭️ Dependabot提交 (secrets不可用)
- ⏭️ 未配置Docker凭据

### 3. 📡 **触发阶段** (条件执行)
**执行条件:** `WEBHOOK_IP` 和 `DOCKER_PASSWORD` 都可用
- 🔗 **连接测试** - 验证webhook端点可达性
- 📡 **部署触发** - 发送详细的部署信息
- 🏷️ **环境区分** - 自动识别生产/开发环境

**跳过情况:**
- ⏭️ 未配置Webhook地址
- ⏭️ 镜像未推送到Hub

### 4. 🧪 **验证阶段** (条件执行)
**执行条件:** 构建成功且有Docker用户名
- 📥 **镜像拉取** - 从Docker Hub拉取刚推送的镜像
- 🚀 **容器测试** - 启动容器并验证运行状态
- 🔍 **健康检查** - 测试应用响应能力
- 🧹 **资源清理** - 自动清理测试资源

## 📊 执行矩阵

| 场景 | 构建 | 发布 | 触发 | 验证 | 说明 |
|------|------|------|------|------|------|
| 🏷️ **正式发布** | ✅ | ✅ | ✅ | ✅ | 完整流程，多平台构建 |
| 👤 **手动推送** | ✅ | ✅ | ✅ | ✅ | 完整流程，单平台构建 |
| 🤖 **Dependabot** | ✅ | ⏭️ | ⏭️ | ✅ | 仅构建和验证 |
| 🔧 **无凭据** | ✅ | ⏭️ | ⏭️ | ⏭️ | 仅构建，适合fork |

## 🔧 配置要求

### Repository Variables
```
DOCKER_USERNAME=your-dockerhub-username
```

### Repository Secrets
```
DOCKER_PASSWORD=your-dockerhub-token
WEBHOOK_IP=your-server-ip (可选)
TRUST_ORIGIN=your-trusted-domains (可选)
```

## 📝 日志输出示例

### 🎯 成功流程
```
🚀 B站登录工具 Docker 构建与发布流程
==================================================

📋 工作流程概览:
  1. 🏗️ 构建阶段 - 编译Docker镜像
  2. 🚀 发布阶段 - 推送到Docker Hub (条件性)
  3. 📡 触发阶段 - 发送部署webhook (条件性)  
  4. 🧪 验证阶段 - 测试发布的镜像

🔍 检查构建环境...
📦 构建模式: 开发构建
🏷️ 版本信息: 1.2.3
🏗️ 构建平台: linux/amd64

📋 执行计划:
  ✅ 构建镜像 - 总是执行
  ✅ 推送到Docker Hub - 将执行
  ⏭️ 更新仓库描述 - 跳过 (开发构建)
  ✅ 触发部署 - 将执行
  ✅ 镜像验证 - 将执行

🎉 Docker镜像构建成功！
🚀 镜像已成功推送到Docker Hub！
📡 正在触发 development 环境部署，镜像标签: dev-a1b2c3d
✅ 部署Webhook触发成功！
🧪 开始验证 开发版本 镜像...
🎉 镜像验证通过！
```

### ⚠️ 受限流程 (Dependabot)
```
📋 执行计划:
  ✅ 构建镜像 - 总是执行
  ⏭️ 推送到Docker Hub - 跳过 (凭据不可用)
  ⏭️ 触发部署 - 跳过 (Webhook未配置或镜像未推送)
  ✅ 镜像验证 - 将执行

🎉 Docker镜像构建成功！
⏭️ 跳过Docker Hub推送 (凭据不可用)
💡 这通常发生在Dependabot提交或未配置Docker凭据时
⏭️ 跳过Webhook触发 (镜像未推送到Hub)
💡 如需自动部署，请配置WEBHOOK_IP和Docker凭据
```

## 🎯 最佳实践

1. **🔐 安全配置**: 使用Docker Hub access token而非密码
2. **🏷️ 标签策略**: 遵循语义化版本控制
3. **🧪 验证环节**: 每次发布后自动验证镜像可用性
4. **📡 webhook设计**: 传递详细的环境和版本信息
5. **📊 监控日志**: 关注各阶段的状态输出

## 🚀 触发方式

### 自动触发
- `git push` 到 main/master 分支
- `git tag v*.*.*` 版本标签推送

### 手动触发
- GitHub Actions页面手动运行
- Re-run失败的任务

---

💡 **提示**: 这个工作流设计确保了构建的可靠性，同时根据环境条件智能调整执行范围，既适合开发环境也适合生产环境。 